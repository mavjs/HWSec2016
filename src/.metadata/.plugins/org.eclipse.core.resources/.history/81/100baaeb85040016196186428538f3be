package backend;

import java.io.*;
import java.security.*;
import java.security.interfaces.*;
import java.util.Calendar;
import java.util.Date;
import java.util.LinkedList;
import java.math.BigInteger;
import java.security.spec.*;

import org.jmrtd.cert.*;

public class Backend implements PublicKey, PrivateKey{
	
	// Deze klasse aanroepen van de functies om wat mee te doen

	public Backend(){
	}
	

	// Setting the monthly allowance that will be distributed to all chargingterminals
	public short monthlyAllowance(){
		//Maybe perform a check if a terminal is a valid CT. 
		short allowance = 50; 	//Max. value is 32767 (inclusive).
		return allowance;
	}
	
	// Return list of revoked 
	public LinkedList<Integer> revokedLists(){
		LinkedList<Integer> list = new LinkedList<Integer>();
		return list;
	}
	
	public CardVerifiableCertificate createCertificate() {
	//	CVCertificateBuilder caBuilder;
		Calendar cal = Calendar.getInstance();
		PublicKey publicKey;
		PrivateKey privateKey;
		CVCPrincipal caRef;
		String algorithmName;
		CVCPrincipal holderRef;
		CVCAuthorizationTemplate authZTemplate;
		String provider;
		Date validFrom = new Date();
		cal.set(Calendar.YEAR, cal.get(Calendar.YEAR)+1);
		Date validTo = cal.getTime();
		System.out.println(dateFormat.format(cal.getTime()));
//		caBuilder = new CVCertificateBuilder();
		try {
			CardVerifiableCertificate cert = CVCertificateBuilder.createCertificate(publicKey, privateKey, algorithmName, caRef, holderRef, authZTemplate, validFrom, validTo, provider);
			return cert;
		} catch (org.ejbca.cvc.exception.ConstructionException e){
			System.out.println("Error");
		}
	}


	@Override
	public String getAlgorithm() {
		// TODO Auto-generated method stub
		return null;
	}


	@Override
	public byte[] getEncoded() {
		// TODO Auto-generated method stub
		return null;
	}


	@Override
	public String getFormat() {
		// TODO Auto-generated method stub
		return null;
	}

	// 1024 bits is not sufficient, but enough for testing phase
	public KeyPair RSAKeyGen(){
		try {
			System.out.println("Generating RSA keys, please wait...");
			KeyPairGenerator generator = KeyPairGenerator.getInstance("RSA");
			generator.initialize(1024);		
			KeyPair keypair = generator.generateKeyPair();
		
			return keypair;
			
		} catch (Exception e){
			e.printStackTrace();
			return null;
		}	
	}
	
	public static void writeKey(Key key, String filename) throws IOException {
		FileOutputStream file = new FileOutputStream(filename);
		file.write(key.getEncoded());
		file.close();
	}
}
